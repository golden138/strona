<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Dodaj użytkownika — prosty frontend</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width:700px; margin:30px auto; padding:10px; }
    label { display:block; margin-top:10px; }
    input, select { padding:6px; width:100%; box-sizing:border-box; }
    button { margin-top:12px; padding:8px 12px; }
    .info { margin-top:12px; color:#555; font-size:0.9em; }
    .ok { color:green }
    .err { color:red }
  </style>

  <!-- bcryptjs CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js" integrity="sha512-+2GQ2qC0nDx2Q3q3QCxqN6lO8GfI1tqfV3tYkq8HgZb4bPZVYc5g7mDq2gvzvYtQ9q0ZLguoXH8M0YfV8qzYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
  <h2>Dodaj użytkownika (formularz do wysyłki)</h2>

  <form id="userForm" method="post" action="https://dziennik_biofizyki.cm.umk.pl/dodawanie_usera.php">
    <label>Login
      <input type="text" name="login" id="login" required />
    </label>

    <label>Hasło (plain)
      <input type="password" name="haslo" id="haslo" required />
    </label>

    <!-- ukryte pole hash które wypełnimy bcryptem -->
    <input type="hidden" name="hash" id="hash">

    <label>Grupa
      <select name="grupa" id="grupa">
        <option value="user">user</option>
        <option value="admin">admin</option>
      </select>
    </label>

    <label>Prowadzący
      <select name="user_prowadzacy" id="user_prowadzacy">
        <option value="1">Adam Kempczyński</option>
        <option value="2">Jerzy Pyskir</option>
        <option value="3">Albert Górnicki</option>
        <option value="4">Alicja Szołna</option>
        <option value="5">Tomasz Wybranowski</option>
        <option value="6">Maciej Bosek</option>
        <option value="7">Michał Cyrankiewicz</option>
        <option value="8">Bronisław Grzegorzewski</option>
        <option value="9">Stefan Kruszewski</option>
        <option value="10">Blanka Ziomkowska</option>
        <option value="11">Małgorzata Pyskir</option>
        <option value="12">Krzysztof Dobosz</option>
        <option value="13">Marta Napiórkowska</option>
        <option value="14">Szymon Radzin</option>
      </select>
    </label>

    <button type="submit" id="submitBtn">Dodaj użytkownika</button>
    <div class="info">Po kliknięciu formularz zostanie wysłany do <code>dodawanie_usera.php</code> z polami <code>login</code>, <code>haslo</code> i <code>hash</code> (bcrypt).</div>
  </form>

  <div id="result" class="info"></div>

  <script>
    (function(){
      const form = document.getElementById('userForm');
      const submitBtn = document.getElementById('submitBtn');
      const result = document.getElementById('result');

      form.addEventListener('submit', function(ev){
        ev.preventDefault();
        result.className='info';
        result.textContent = 'Generuję hash...';

        const passwd = document.getElementById('haslo').value;
        if(!passwd) {
          result.className='info err';
          result.textContent = 'Podaj hasło!';
          return;
        }

        // koszt bcrypt — 10 to dobry kompromis (zgodny z typową konfiguracją PHP)
        const saltRounds = 10;

        // bcryptjs async hash
        bcrypt.hash(passwd, saltRounds, function(err, hashed) {
          if(err) {
            result.className='info err';
            result.textContent = 'Błąd generowania hasha: ' + err;
            return;
          }

          // wstawiamy wygenerowany hash do ukrytego pola
          document.getElementById('hash').value = hashed;

          // opcjonalnie: wyślij formularz przez fetch, żeby pokazać odpowiedź
          // tutaj użyjemy fetch aby wyświetlić odpowiedź serwera w polu result
          submitBtn.disabled = true;
          result.textContent = 'Wysyłam formularz...';

          // zbuduj body jak formularz
          const formData = new FormData(form);

          fetch(form.action, {
            method: 'POST',
            credentials: 'include', // próba wysłania ciasteczek sesji jeśli są (ważne jeśli wymagana autoryzacja)
            body: formData
          }).then(response => response.text())
            .then(text => {
              submitBtn.disabled = false;
              result.className='info ok';
              // pokaż krótki podgląd odpowiedzi
              result.innerHTML = '<strong>Odpowiedź serwera:</strong><br><pre style="white-space:pre-wrap; background:#f7f7f7; padding:8px;">' + escapeHtml(text).slice(0,4000) + '</pre>';
            })
            .catch(e => {
              submitBtn.disabled = false;
              result.className='info err';
              result.textContent = 'Błąd wysyłki: ' + e;
            });
        });
      });

      function escapeHtml(unsafe) {
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    })();
  </script>
</body>
</html>
